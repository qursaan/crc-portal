{% extends "fed-body.html" %}

{% block htitle %}

{% endblock %}

{% block fedbody %}
    <h3>Site Information</h3>

    <form id="infoform" enctype="multipart/form-data" class="form-horizontal" action="" method="post" role="form"
          onsubmit="return(validate());">
        {% csrf_token %}
        <fieldset>
            <div class="form-group">
                <label for="site_name" class="col-xs-2 control-label">Site Name</label>
                <div class="col-xs-4">
                    <input id="site_name" type="text" name="site_name" class="form-control"
                           minlength="2" value="{% if site_name != None %}{{ site_name }}{% endif %}" placeholder="Site Name" required/>
                </div>
            </div>
            <div class="form-group">
                <label for="site_url" class="col-xs-2 control-label">Site Portal URL</label>
                <div class="col-xs-4">
                    <input id="site_url" type="text" name="site_url" class="form-control"
                           minlength="2" value="{% if site_url != None %}{{ site_url }}{% endif %}" placeholder="Site Servies URL" required/>
                </div>
            </div>
            <div class="form-group">
                <label for="site_ip" class="col-xs-2 control-label">Federation IP URL</label>
                <div class="col-xs-4">
                    <input id="site_ip" type="text" name="site_ip" class="form-control"
                           minlength="2" value="{% if site_ip != None %}{{ site_ip }}{% endif %}" placeholder="Federation IP URL" required/>
                </div>
            </div>
            <div class="form-group">
                <label for="site_location" class="col-xs-2 control-label">Location</label>
                <div class="col-xs-4">
                    <input id="site_location" type="text" name="site_location" class="form-control"
                           minlength="2" value="{% if site_location !=  None %}{{ site_location }}{% endif %}" placeholder="Physical Location" required/>
                </div>
            </div>
            <div class="form-group">
                <label for="site_contact" class="col-xs-2 control-label">Contact</label>
                <div class="col-xs-4">
                    <input id="site_contact" type="text" name="site_contact" class="form-control"
                           minlength="2" value="{% if site_contact !=  None %}{{ site_contact }}{% endif %}" placeholder="Contact Email/Phone" required/>
                </div>
            </div>
            <div class="form-group">
                <label for="site_pkey" class="col-xs-2 control-label">Public Key</label>
                <div class="col-xs-4">
                    <textarea id="site_pkey" row="10" cols="30" name="site_pkey" {% if site_info == 1 %}
                              readonly="readonly"
                              {% else %}required {% endif %}placeholder="Public Key">{{ site_pkey }}</textarea>
                </div>
            </div>
            <br/>

            <div class="col-xs-12">
                <div class="form-group">
                    <div class="col-xs-2"></div>
                    <div class="col-xs-10">
                        <div id="validation_error" class="" role="alert"></div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-xs-2"></div>

                    <div class="ui-widget btn-toolbar col-xs-10" role="group">
                        <div class="btn-group" role="group">
                            <button id="back" name="s_back" class="btn btn-danger" type="button"
                                    onclick="location.href='/federation/list/'">
                                Back
                            </button>
                        </div>
                        {% if site_info == 0 %}
                            <div class="btn-group" role="group">
                                <button id="validation" name="s_validate" class="btn btn-warning" type="button">
                                    Validate
                                </button>
                            </div>
                        {% endif %}
                        <div class="btn-group" role="group">
                            <button id="save_info" name="s_save" class="submit btn btn-success" type="submit">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </fieldset>
    </form>


    <script>
        var v_range = 0;
        var v_info = "{{site_info}}";

        function set_validation(v_type, msg) {
            $('#validation_error').removeAttr('class');
            $('#validation_error').html(msg);
            if (v_type == 1) {
                $('#validation_error').attr('class', "alert alert-success");
            } else if (v_type == 2) {
                $('#validation_error').attr('class', "alert alert-danger");
            } else if (v_type == 3) {
                $('#validation_error').attr('class', "alert alert-danger");
            }
        };

        function validate() {
            set_validation(0, "");
            if (v_info == "1") {
                return true;
            }

            if (v_range == 0) {
                set_validation(3, "Please validate the site first before submit");
                return false;
            }
            return true;
        };

        function checking_validation(siteurl, sitepkey) {
            $.ajax({
                url: "site_validate",
                type: "POST",
                data: {site_url: siteurl, site_pkey: sitepkey},
                success: function (result) {
                    if (result['key'] == "1") {
                        set_validation(1, "Key is valid");
                        v_range = 1;
                    } else if (result['key'] == "0") {
                        set_validation(3, "key is not a valid/ or site not responses");
                        v_range = 0;
                    } else {
                        set_validation(3, "Site is not responding");
                        v_range = 0;
                    }
                },
                error: function (xhr, errmsg, err) {
                    console.log(err);
                    set_validation(2, "Server Error, try again later");
                }
            });
        };
        /*******************************************check validation*********/
        $("#validation").on('click', function (event) {
            event.preventDefault();
            set_validation(0, "...");

            siteurl = $('input[name="site_ip"]').val();
            sitekey = $('textarea#site_pkey').val();
            if (siteurl == "" || sitekey == "") {
                set_validation(2, "Please enter the site url/key");
                return false;
            }

            checking_validation(siteurl, sitekey);

        });
    </script>

{% endblock %}